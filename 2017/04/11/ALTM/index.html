<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="image processing,java,opencv," />





  <link rel="alternate" href="/atom.xml" title="Isaac Changhau" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/tltimg.jpg?v=5.1.1" />






<meta name="description" content="This short paper, published by Ahn et al. on ICCE, introduces a new tone mapping technique for HDR images based on the retinex theory.">
<meta name="keywords" content="image processing,java,opencv">
<meta property="og:type" content="article">
<meta property="og:title" content="Adaptive Local Tone Mapping Technique for HDR Image and Java Implementation">
<meta property="og:url" content="https://isaacchanghau.github.io/2017/04/11/ALTM/index.html">
<meta property="og:site_name" content="Isaac Changhau">
<meta property="og:description" content="This short paper, published by Ahn et al. on ICCE, introduces a new tone mapping technique for HDR images based on the retinex theory.">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://isaacchanghau.github.io/images/imageprocessing/altm/iris.png">
<meta property="og:image" content="https://isaacchanghau.github.io/images/imageprocessing/altm/whitehouse.png">
<meta property="og:image" content="https://isaacchanghau.github.io/images/imageprocessing/altm/horses.png">
<meta property="og:image" content="https://isaacchanghau.github.io/images/imageprocessing/altm/liahthouse.png">
<meta property="og:updated_time" content="2017-11-01T09:05:01.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Adaptive Local Tone Mapping Technique for HDR Image and Java Implementation">
<meta name="twitter:description" content="This short paper, published by Ahn et al. on ICCE, introduces a new tone mapping technique for HDR images based on the retinex theory.">
<meta name="twitter:image" content="https://isaacchanghau.github.io/images/imageprocessing/altm/iris.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":true,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://isaacchanghau.github.io/2017/04/11/ALTM/"/>





  <title>Adaptive Local Tone Mapping Technique for HDR Image and Java Implementation | Isaac Changhau</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <!--<a href="https://github.com/IsaacChanghau"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>-->

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Isaac Changhau</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay Hungry, Stay Foolish</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th-list"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-vcard"></i> <br />
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://isaacchanghau.github.io/2017/04/11/ALTM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Isaac Changhau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Isaac Changhau">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Adaptive Local Tone Mapping Technique for HDR Image and Java Implementation</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-11T19:08:28+08:00">
                2017-04-11
              </time>
            

            
              <span class="post-updated">
                &nbsp; | &nbsp; <i class="fa fa-calendar-check-o"></i> Updated on
                <time itemprop="dateUpdated" datetime="2017-11-01T17:05:01+08:00" content="2017-11-01">
                  2017-11-01
                </time>
              </span>
            

            

            
          </span>

          
            <span class="post-letters-count">
              &nbsp; | &nbsp;
              <i class="fa fa-file-word-o"></i>
            <span>Count 1,926 words</span>
              <!--&nbsp; | &nbsp;
              <i class="fa fa-clock-o"></i>
            <span>Reading 12 min</span>-->
            </span>
          

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Image-Processing/" itemprop="url" rel="index">
                    <span itemprop="name">Image Processing</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>This short paper, published by Ahn et al. on ICCE, introduces a new tone mapping technique for HDR images based on the retinex theory.<a id="more"></a> Here I summarize this paper and show the Java implementation with OpenCV to realize the proposed algorithm.</p>
<h1 id="Center-Surround-Retinex"><a href="#Center-Surround-Retinex" class="headerlink" title="Center/Surround Retinex"></a>Center/Surround Retinex</h1><p>The <a href="https://en.wikipedia.org/wiki/Color_constancy#Retinex_theory" target="_blank" rel="noopener">retinex theory</a>, initially defined by <a href="https://www.osapublishing.org/josa/abstract.cfm?uri=josa-61-1-1" target="_blank" rel="noopener">Land et al.</a>, explains how the realiable color information from the real world is extracted by human visual system, and <em>Jobson et al.</em> introduced the single-scale retinex (<a href="http://www.ipol.im/pub/art/2014/107/article_lr.pdf" target="_blank" rel="noopener">SSR</a>) and multi-scale retinex (<a href="http://www.ipol.im/pub/art/2014/107/article_lr.pdf" target="_blank" rel="noopener">MSR</a>) based on Landâ€™s surround retinex theory. Generally, SSR is computed by$$R_{i}(x,y)=\log\big(I_{i}(x,y)\big)-\log\big(F(x,y)*I_{i}(x,y)\big)$$where $x$, $y$ are the pixel coordinates in the image, $R_{i}(x,y)$ denotes the retinex output of $i^{th}$ spectral band, $I_{i}(x,y)$ is the image distribution in the $i^{th}$ spectral band, $*$ represents convolution operation, and $F(x,y)$ is the Gaussian surround function, defined by$$F(x,y)=K\centerdot e^{-\frac{x^{2}+y^{2}}{c^{2}}}$$where $c$ is Gaussian surround space constant, $K$ is normalization factor. In Addition, MSR is described as$$R_{MSR_{i}}(x,y)=\sum_{n=1}^{N}\omega_{n}\centerdot R_{n_{i}}(x,y)$$where $N$ is the number of scales, $R_{n_{i}}(x,y)$ denotes the $i^{th}$ component of the $n^{th}$ scale, $R_{MSR_{i}}(x,y)$ denotes $i^{th}$ spectral component of the MSR output, and $\omega_{n}$ is the weight associated with the $n^{th}$ scale.</p>
<p>The purpose of MSR is to reduce halo artifacts around high contrast edges and to keep balance with the dynamic range compression and the color rendition. MSR produces good dynamic range compression, but still suffer from halo artifacts. In addition, SSR with small space constant makes large uniform regions graying out and flat-looking in images.</p>
<h1 id="Adaptive-Local-Tone-Mapping"><a href="#Adaptive-Local-Tone-Mapping" class="headerlink" title="Adaptive Local Tone Mapping"></a>Adaptive Local Tone Mapping</h1><p>For ALTM, there are two processes, one is applying a global tone mapping, and another is a local tone mapping based on retinex algorithm.</p>
<h2 id="Global-Adaptation"><a href="#Global-Adaptation" class="headerlink" title="Global Adaptation"></a>Global Adaptation</h2><p>Global adaptation simulates the early stage of human visual system, which senses brightness as an approximate logarithmic function according to the <a href="https://en.wikipedia.org/wiki/Weber%E2%80%93Fechner_law" target="_blank" rel="noopener">Weber-Fechner law</a>. The global adaptation is defined by$$L_{g}(x,y)=\frac{\log\big(\frac{L_{w}(x,y)}{\bar{L}_{w}}+1\big)}{\log\big(\frac{L_{w\max}}{\bar{L}_{w}}+1\big)}$$where $L_{g}(x,y)$ is global adaptation output, $L_{w}(x,y)$ is input luminance values, $L_{w\max}$ is maximum luminance value, $\bar{L}_{w}$ is the logarithmic average luminance and given as$$\bar{L}_{w}=e^{\frac{1}{m}\sum_{x,y}\log\big(\delta+L_{w}(x,y)\big)}$$where $m$ is the total number of pixels of one channel in the image and $\delta$ is a small value to prevent the singularity that occurs if black pixels are present. Moreover, the input world luminance values $L_{w}(x,y)$ is derived by$$L_{w}(x,y)=0.299\centerdot Red(x,y)+0.587\centerdot Green(x,y)+0.114\centerdot Blue(x,y)$$according to the paper, and $Red$, $Green$ and $Blue$ denote the three color channels of the input image respectivaly. Below shows the Java implementation with OpenCV to derive the global adaptation:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Global Adaptation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> b blue channel of input image</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> g green channel of input image</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> r red channel of input image</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rows number of rows of the input image</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cols number of cloumns of the input image</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a Mat list contains global adaptation output (Lg) and input world luminance values (Lw)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Mat&gt; <span class="title">globalAdaptation</span><span class="params">(Mat b, Mat g, Mat r, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Calculate Lw &amp; maximum of Lw</span></span><br><span class="line">	Mat Lw = <span class="keyword">new</span> Mat(rows, cols, r.type());</span><br><span class="line">	Core.multiply(r, <span class="keyword">new</span> Scalar(rParam), r); <span class="comment">// rParam = 0.299</span></span><br><span class="line">	Core.multiply(g, <span class="keyword">new</span> Scalar(gParam), g); <span class="comment">// gParam = 0.587</span></span><br><span class="line">	Core.multiply(b, <span class="keyword">new</span> Scalar(bParam), b); <span class="comment">// bParam = 0.114</span></span><br><span class="line">	Core.add(r, g, Lw);</span><br><span class="line">	Core.add(Lw, b, Lw);</span><br><span class="line">	<span class="keyword">double</span> LwMax = Core.minMaxLoc(Lw).maxVal; <span class="comment">// the maximum luminance value</span></span><br><span class="line">	<span class="comment">// Calculate log-average luminance and get global adaptation result</span></span><br><span class="line">	Mat Lw_ = Lw.clone();</span><br><span class="line">	Core.add(Lw_, <span class="keyword">new</span> Scalar(<span class="number">0.001</span>), Lw_);</span><br><span class="line">	Core.log(Lw_, Lw_);</span><br><span class="line">	<span class="keyword">double</span> LwAver = Math.exp(Core.sumElems(Lw_).val[<span class="number">0</span>] / (rows * cols));</span><br><span class="line">	Mat Lg = Lw.clone();</span><br><span class="line">	Core.divide(Lg, <span class="keyword">new</span> Scalar(LwAver), Lg);</span><br><span class="line">	Core.add(Lg, <span class="keyword">new</span> Scalar(<span class="number">1.0</span>), Lg);</span><br><span class="line">	Core.log(Lg, Lg);</span><br><span class="line">	Core.divide(Lg, <span class="keyword">new</span> Scalar(Math.log(LwMax / LwAver + <span class="number">1.0</span>)), Lg); <span class="comment">// Lg is the global adaptation</span></span><br><span class="line">	List&lt;Mat&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	list.add(Lw);</span><br><span class="line">	list.add(Lg);</span><br><span class="line">	<span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Local-Adaptation"><a href="#Local-Adaptation" class="headerlink" title="Local Adaptation"></a>Local Adaptation</h2><p>Local adaptation based on the retinex theory is applied after the global adaptation process. The output of SSR (and MSR) suffers strong halo artifacts and looks unnatural. In order to deal with these drawbacks, an edge-preserving filter, <a href="http://kaiminghe.com/eccv10/" target="_blank" rel="noopener">guided filter</a> is used in this paper, is intorduced to substitute the Gaussian filter of the retinex algorithm to reduce the halo artifact effects. The guided filter is an edge-preserving filter like the <a href="https://www.google.com.sg/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwivkrb477fUAhWFrY8KHVOPBl4QFgggMAA&amp;url=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FBilateral_filter&amp;usg=AFQjCNGR1HnnDTVK6h4lLUSHtoOYCpEsAA" target="_blank" rel="noopener">bilateral filter</a> whose weights depend not only on the Euclidean distances but also on the luminance differences. These filters behave similar, but the guided filter has better performance near the edges. Also, its computational complexity is linear-time without approximation and independent of the kernel size. The local adaptation equation can be written as$$L_{l}(x,y)=\log L_{g}(x,y)-\log H_{g}(x,y)$$where $L_{l}(x,y)$ denotes the local adaptation output, and $H_{g}(x,y)$ denotes the output of the guided filter global adaptation result. Mathematically, the guided filter is defined as$$H_{g}(x,y)=\frac{1}{|\omega|}\sum_{(\zeta_{x},\zeta_{y})\in\omega(x,y)}\big(a(\zeta_{x},\zeta_{y})\centerdot L_{g}(x,y)+b(\zeta_{x},\zeta_{y})\big)$$where $\zeta_{x}$, $\zeta_{y}$ are the neighborhood pixel coordinates, $\omega(x,y)$ is a local square window of a radius $r$ centered at pixel $(x,y)$, $|\omega|$ represents the number of pixels in $\omega(x,y)$, while $a(\zeta_{x},\zeta_{y})$ and $b(\zeta_{x},\zeta_{y})$ are linear coefficients, which are computed by$$a(\zeta_{x},\zeta_{y})=\frac{\mu_{2}(\zeta_{x},\zeta_{y})-\mu^{2}(\zeta_{x},\zeta_{y})}{\sigma^{2}(\zeta_{x},\zeta_{y})+\varepsilon}\\b(\zeta_{x},\zeta_{y})=\mu(\zeta_{x},\zeta_{y})-a(\zeta_{x},\zeta_{y})\centerdot\mu(\zeta_{x},\zeta_{y})$$where $\mu(\zeta_{x},\zeta_{y})$ and $\sigma^{2}(\zeta_{x},\zeta_{y})$ are the mean and variance of $L_{g}$ in $\omega(\zeta_{x},\zeta_{y})$, $\mu_{2}(\zeta_{x},\zeta_{y})$ is the mean of $L_{g}^{2}$ in $\omega(\zeta_{x},\zeta_{y})$, and $\varepsilon$ is a regularization parameter. Below is the Java codes to obtain the $H_{g}$, and the implementation details of guided filter can be found in my GitHub repository: <a href="https://github.com/IsaacChanghau/ALTMRetinex/blob/master/src/main/java/com/isaac/utils/Filters.java" target="_blank" rel="noopener">[link]</a>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Local Adaptation (Guided Image Filter Result)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> Lg global adaptation output</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rows number of rows of the input image</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cols number of cloumns of the input image</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> local adaptation result</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Mat <span class="title">localAdaptation</span><span class="params">(Mat Lg, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> krnlSz = Arrays.asList(<span class="number">3.0</span>, rows * krnlRatio, cols * krnlRatio).stream().max(Double::compare).get().intValue();</span><br><span class="line">	<span class="comment">// maximum filter: using dilate to extract the local maximum of a image block, which acts as the maximum filter</span></span><br><span class="line">	<span class="comment">// Meanwhile, minimum filter can be achieved by using erode function</span></span><br><span class="line">	Mat Lg_ = <span class="keyword">new</span> Mat();</span><br><span class="line">	Mat kernel = Imgproc.getStructuringElement(Imgproc.MORPH_RECT, <span class="keyword">new</span> Size(krnlSz, krnlSz), <span class="keyword">new</span> Point(-<span class="number">1</span>, -<span class="number">1</span>));</span><br><span class="line">	Imgproc.dilate(Lg, Lg_, kernel);</span><br><span class="line">	<span class="comment">// guided image filter</span></span><br><span class="line">	Mat Hg = Filters.GuidedImageFilter(Lg, Lg_, r, eps);</span><br><span class="line">	<span class="keyword">return</span> Hg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>After obtaining the result of global aadaptation filtered by edge-preserving filter, instead of applying the local adaptation equation directly, two factors are intorduced to prevent the flat-looking appearance caused by the filter and improve the performance of the algorithm. One is the contrast enhancement factor and another is adaptive nonlinearity offset. The contrast enhancement factor is computed by$$\alpha(x,y)=1+\eta\centerdot\frac{L_{g}(x,y)}{L_{g\max}}$$where $\eta$ is the contrast control parameter, and $L_{g\max}$ is the maximum luminance value of global adaptation output. And the adaptive nonlinearity offset is written as$$\beta=\lambda\centerdot\bar{L}_{g}$$which varies in accordance with the scene contents, and $\lambda$ is the nonlinearity control parameter, $\bar{L}_{g}$ is the logarithmic average luminance of the global adaptation output. After deriving these two factors, the final local adaptation equation is established as$$L_{out}(x,y)=\alpha(x,y)\centerdot\log\bigg(\frac{L_{g}(x,y)}{H_{g}(x,y)}+\beta\bigg)$$where $L_{out}(x,y)$ is the final local adaptation output. Below is the Java Codes to obtain the final local adaptation output:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Mat alpha = <span class="keyword">new</span> Mat(m, n, rChannel.type());</span><br><span class="line">Core.divide(Lg, <span class="keyword">new</span> Scalar(Core.minMaxLoc(Lg).maxVal / eta), alpha);</span><br><span class="line">Core.add(alpha, <span class="keyword">new</span> Scalar(<span class="number">1.0</span>), alpha);</span><br><span class="line">Mat Lg_ = <span class="keyword">new</span> Mat(m, n, rChannel.type());</span><br><span class="line">Core.add(Lg, <span class="keyword">new</span> Scalar(<span class="number">1.0</span> / <span class="number">255.0</span>), Lg_);</span><br><span class="line">Core.log(Lg_, Lg_);</span><br><span class="line"><span class="keyword">double</span> beta = Math.exp(Core.sumElems(Lg_).val[<span class="number">0</span>] / (m * n)) * lambda;</span><br><span class="line">Mat Lout = <span class="keyword">new</span> Mat(m, n, rChannel.type());</span><br><span class="line">Core.divide(Lg, Hg, Lout);</span><br><span class="line">Core.add(Lout, <span class="keyword">new</span> Scalar(beta), Lout);</span><br><span class="line">Core.log(Lout, Lout);</span><br><span class="line">Core.normalize(alpha.mul(Lout), Lout, <span class="number">0</span>, <span class="number">255</span>, Core.NORM_MINMAX);</span><br></pre></td></tr></table></figure></p>
<p>After the local adaptation, the processed luminance values are rescaled from 0 to 1. Finally, the tone mapped image is obtained from the luminance values of the local adaptation output and the input HDR image. Here is the Java codes to do the mapping process:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Mat gain = obtainGain(Lout, Lw, m, n);</span><br><span class="line"><span class="comment">// output</span></span><br><span class="line">Core.divide(rChannel.mul(gain), <span class="keyword">new</span> Scalar(Core.minMaxLoc(rChannel).maxVal / <span class="number">255.0</span>), rChannel); <span class="comment">// Red Channel</span></span><br><span class="line">Core.divide(gChannel.mul(gain), <span class="keyword">new</span> Scalar(Core.minMaxLoc(gChannel).maxVal / <span class="number">255.0</span>), gChannel); <span class="comment">// Green Channel</span></span><br><span class="line">Core.divide(bChannel.mul(gain), <span class="keyword">new</span> Scalar(Core.minMaxLoc(bChannel).maxVal / <span class="number">255.0</span>), bChannel); <span class="comment">// Blue Channel</span></span><br><span class="line"><span class="comment">// merge three color channels to a image</span></span><br><span class="line">Mat outval = <span class="keyword">new</span> Mat();</span><br><span class="line">Core.merge(<span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(bChannel, gChannel, rChannel)), outval);</span><br><span class="line">outval.convertTo(outval, CvType.CV_8UC1);</span><br></pre></td></tr></table></figure></p>
<p>Where the <code>gain</code> is derived by<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Mat <span class="title">obtainGain</span><span class="params">(Mat Lout, Mat Lw, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols)</span> </span>&#123;</span><br><span class="line">	Mat gain = <span class="keyword">new</span> Mat(rows, cols, Lout.type());</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rows; i++) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Lw.get(i, j)[<span class="number">0</span>] == <span class="number">0</span>)</span><br><span class="line">				gain.put(i, j, Lout.get(i, j)[<span class="number">0</span>]);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				gain.put(i, j, Lout.get(i, j)[<span class="number">0</span>] / Lw.get(i, j)[<span class="number">0</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> gain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The full Java Codes are available in my GitHub repository: <a href="https://github.com/IsaacChanghau/OptimizedImageEnhance/blob/master/src/main/java/com/isaac/models/ALTMRetinex.java" target="_blank" rel="noopener">ALTMRetinex</a>, while Matlab codes are here: <a href="https://github.com/IsaacChanghau/OptimizedImageEnhance/tree/master/matlab/ALTMRetinex" target="_blank" rel="noopener">[link]</a></p>
<h1 id="Experiment-Result"><a href="#Experiment-Result" class="headerlink" title="Experiment Result"></a>Experiment Result</h1><p>Here we exhibit some results generated by ALTM methods. And the image display method used is provided by <a href="https://github.com/master-atul/ImShow-Java-OpenCV" target="_blank" rel="noopener">ImShow-Java-OpenCV</a>.<br><img src="/images/imageprocessing/altm/iris.png" alt="Iris"><br><img src="/images/imageprocessing/altm/whitehouse.png" alt="White House"><br><img src="/images/imageprocessing/altm/horses.png" alt="Horses"><br><img src="/images/imageprocessing/altm/liahthouse.png" alt="Liahthouse"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="http://koasas.kaist.ac.kr/bitstream/10203/172985/1/73275.pdf" target="_blank" rel="noopener">Adaptive Local Tone Mapping Based on Retinex for High Dynamic Range Images</a></li>
<li><a href="http://www.ipol.im/pub/art/2014/107/article_lr.pdf" target="_blank" rel="noopener">Multiscale Retinex</a></li>
<li><a href="https://github.com/master-atul/ImShow-Java-OpenCV" target="_blank" rel="noopener">ImShow-Java-OpenCV</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>Author:</strong>
      Isaac Changhau
    </li>
    <li class="post-copyright-link">
      <strong>Link:</strong>
      <a href="https://isaacchanghau.github.io/2017/04/11/ALTM/" title="Adaptive Local Tone Mapping Technique for HDR Image and Java Implementation">https://isaacchanghau.github.io/2017/04/11/ALTM/</a>
    </li>
    <li class="post-copyright-license">
      <strong>Notice: </strong>
      All articles are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally. Contact me via email for questions or discussion.
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/image-processing/" rel="tag"># image processing</a>
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/opencv/" rel="tag"># opencv</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/10/Installing-OpenCV-for-Java/" rel="next" title="Installing OpenCV for Java [Reprinted]">
                <i class="fa fa-chevron-left"></i> Installing OpenCV for Java [Reprinted]
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/15/Underwater-Image-Enhance-via-Fusion/" rel="prev" title="Underwater Image Enhance via Fusion and Its Java Implementation">
                Underwater Image Enhance via Fusion and Its Java Implementation <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Isaac Changhau" />
          <p class="site-author-name" itemprop="name">Isaac Changhau</p>
           
              <p class="site-description motion-element" itemprop="description">Stay Hungry, Stay Foolish</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">43</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">40</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="mailto:isaac.changhau@gmail.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                  Email
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/isaac-changhau" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/IsaacChanghau" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Center-Surround-Retinex"><span class="nav-number">1.</span> <span class="nav-text">Center/Surround Retinex</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Adaptive-Local-Tone-Mapping"><span class="nav-number">2.</span> <span class="nav-text">Adaptive Local Tone Mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Global-Adaptation"><span class="nav-number">2.1.</span> <span class="nav-text">Global Adaptation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Local-Adaptation"><span class="nav-number">2.2.</span> <span class="nav-text">Local Adaptation</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Experiment-Result"><span class="nav-number">3.</span> <span class="nav-text">Experiment Result</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">4.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-star"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Isaac Changhau</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>


        

        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  

  
  


  

  

</body>
</html>
